From d93a20042659927a8476e057d01de82cf1999f9a Mon Sep 17 00:00:00 2001
From: Milan Shah <mshah@mvista.com>
Date: Tue, 24 Mar 2020 14:43:19 +0530
Subject: [PATCH] fix heap-buffer-overflow in memcmp

Upstream-Status: Backport from [ https://github.com/openSUSE/libsolv/commit/fdb9c9c0350 ]
CVE: CVE-2019-20387
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 src/repodata.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/repodata.c b/src/repodata.c
index 4ab5d18..94c15ce 100644
--- a/src/repodata.c
+++ b/src/repodata.c
@@ -205,11 +205,13 @@ repodata_schema2id(Repodata *data, Id *schema, int create)
   cid = schematahash[h];
   if (cid)
     {
-      if (!memcmp(data->schemadata + data->schemata[cid], schema, len * sizeof(Id)))
+      if ((data->schemata[cid] + len <= data->schemadatalen) &&
+			  !memcmp(data->schemadata + data->schemata[cid], schema, len * sizeof(Id)))
         return cid;
       /* cache conflict, do a slow search */
       for (cid = 1; cid < data->nschemata; cid++)
-        if (!memcmp(data->schemadata + data->schemata[cid], schema, len * sizeof(Id)))
+        if ((data->schemata[cid] + len <= data->schemadatalen) &&
+				!memcmp(data->schemadata + data->schemata[cid], schema, len * sizeof(Id)))
           return cid;
     }
   /* a new one */
-- 
2.7.4

