From 58887646076f5870cd2e2e57c626c9e23a21953f Mon Sep 17 00:00:00 2001
From: Dave Reisner <dreisner@archlinux.org>
Date: Wed, 31 Jul 2019 13:09:36 -0400
Subject: [PATCH] Fix failing chmod calls on installation for suidubins

suidubins should be suidusbins, since these binaries are installed
${prefix}/sbin. This historically hasn't broken the build because
chmod of newgidmap/newuidmap succeeds, causing make to think the command
succeeded. Configuring shadow with --with-fcaps removes these final two
entries and exposes the chmod failure to make.

CVE: CVE-2019-19882
Upstream-Status: Backport
Signed-off-by: Sam Kappen <skappen@mvista.com>
---
 src/Makefile.am | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/Makefile.am b/src/Makefile.am
index 076f8ef..316a6c4 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -51,13 +51,14 @@ usbin_PROGRAMS = \
 # id and groups are from gnu, sulogin from sysvinit
 noinst_PROGRAMS = id sulogin
 
+suidusbins     =
 suidbins       = su
 suidubins      = chage chfn chsh expiry gpasswd newgrp passwd
 if ENABLE_SUBIDS
 suidubins += newgidmap newuidmap
 endif
 if ACCT_TOOLS_SETUID
-	suidubins += chage chgpasswd chpasswd groupadd groupdel groupmod newusers useradd userdel usermod
+	suidusbins += chage chgpasswd chpasswd groupadd groupdel groupmod newusers useradd userdel usermod
 endif
 
 if WITH_TCB
@@ -129,6 +130,9 @@ install-am: all-am
 	for i in $(suidubins); do \
 		chmod -f $(suidperms) $(DESTDIR)$(ubindir)/$$i; \
 	done
+	for i in $(suidusbins); do \
+		chmod $(suidperms) $(DESTDIR)$(usbindir)/$$i; \
+	done
 if WITH_TCB
 	for i in $(shadowsgidubins); do \
 		chown root:shadow $(DESTDIR)$(ubindir)/$$i; \
-- 
2.6.4

