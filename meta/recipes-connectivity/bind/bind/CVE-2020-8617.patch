From 1ec90167d943418b410784d6c8be67e2e6a79a21 Mon Sep 17 00:00:00 2001
From: Mark Andrews <marka@isc.org>
Date: Wed, 25 Mar 2020 17:46:26 +1100
Subject: [PATCH 2/2] Only look at tsig.error in responses

Upstream Status: Backport https://gitlab.isc.org/isc-projects/bind9/-/commit/42af79ae
CVE: CVE-2020-8617

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 lib/dns/tsig.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/lib/dns/tsig.c b/lib/dns/tsig.c
index 13612cb..84ac77c 100644
--- a/lib/dns/tsig.c
+++ b/lib/dns/tsig.c
@@ -1484,8 +1484,8 @@ dns_tsig_verify(isc_buffer_t *source, dns_message_t *msg,
 		} else if (ret != ISC_R_SUCCESS) {
 			goto cleanup_context;
 		}
-	} else if (tsig.error != dns_tsigerror_badsig &&
-		   tsig.error != dns_tsigerror_badkey) {
+	} else if (!response || (tsig.error != dns_tsigerror_badsig &&
+				 tsig.error != dns_tsigerror_badkey)) {
 		tsig_log(msg->tsigkey, 2, "signature was empty");
 		return (DNS_R_TSIGVERIFYFAILURE);
 	}
@@ -1551,7 +1551,7 @@ dns_tsig_verify(isc_buffer_t *source, dns_message_t *msg,
 		}
 	}
 
-	if (tsig.error != dns_rcode_noerror) {
+	if (response && tsig.error != dns_rcode_noerror) {
 		msg->tsigstatus = tsig.error;
 		if (tsig.error == dns_tsigerror_badtime)
 			ret = DNS_R_CLOCKSKEW;
-- 
2.28.0

