From 2b90b231ea8d4b4b1d0694b3876968e5eeee7d83 Mon Sep 17 00:00:00 2001
From: Sunil Kumar <sukumar@mvista.com>
Date: Thu, 21 Feb 2019 13:27:20 +0530
Subject: [PATCH] CVE-2018-5740 fix

Backported from
https://ftp.isc.org/isc/bind9/9.10.8-P1/patches/CVE-2018-5740

Upstream-Status: Backport
CVE: CVE-2018-5740

Signed-off-by: Sunil Kumar <sukumar@mvista.com>
---
 CHANGES            |  4 ++++
 lib/dns/resolver.c | 19 +++++++++++++++----
 2 files changed, 19 insertions(+), 4 deletions(-)

diff --git a/CHANGES b/CHANGES
index 2e957dd..10c44ab 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,3 +1,7 @@
+4997.	[security]	named could crash during recursive processing
+			of DNAME records when "deny-answer-aliases" was
+			in use. (CVE-2018-5740) [GL #387]
+
 	--- 9.10.5-P3 released ---
 
 4647.	[bug]		Change 4643 broke verification of TSIG signed TCP
diff --git a/lib/dns/resolver.c b/lib/dns/resolver.c
index 6963a47..6ba85af 100644
--- a/lib/dns/resolver.c
+++ b/lib/dns/resolver.c
@@ -6176,6 +6176,7 @@ is_answertarget_allowed(fetchctx_t *fctx, dns_name_t *qname, dns_name_t *rname,
 	unsigned int nlabels;
 	dns_fixedname_t fixed;
 	dns_name_t prefix;
+	int order;
 
 	REQUIRE(rdataset != NULL);
 	REQUIRE(rdataset->type == dns_rdatatype_cname ||
@@ -6198,18 +6199,26 @@ is_answertarget_allowed(fetchctx_t *fctx, dns_name_t *qname, dns_name_t *rname,
 		tname = &cname.cname;
 		break;
 	case dns_rdatatype_dname:
+		if (dns_name_fullcompare(qname, rname, &order, &nlabels) !=
+		    dns_namereln_subdomain)
+		{
+			return (ISC_TRUE);
+		}
 		result = dns_rdata_tostruct(&rdata, &dname, NULL);
 		RUNTIME_CHECK(result == ISC_R_SUCCESS);
 		dns_name_init(&prefix, NULL);
 		dns_fixedname_init(&fixed);
 		tname = dns_fixedname_name(&fixed);
-		nlabels = dns_name_countlabels(qname) -
-			  dns_name_countlabels(rname);
+		nlabels = dns_name_countlabels(rname);
 		dns_name_split(qname, nlabels, &prefix, NULL);
 		result = dns_name_concatenate(&prefix, &dname.dname, tname,
 					      NULL);
-		if (result == DNS_R_NAMETOOLONG)
+		if (result == DNS_R_NAMETOOLONG) {
+			if (chainingp != NULL) {
+				*chainingp = ISC_TRUE;
+			}
 			return (ISC_TRUE);
+		}
 		RUNTIME_CHECK(result == ISC_R_SUCCESS);
 		break;
 	default:
@@ -6938,7 +6947,9 @@ answer_response(fetchctx_t *fctx) {
 		}
 		if ((ardataset->type == dns_rdatatype_cname ||
 		     ardataset->type == dns_rdatatype_dname) &&
-		     !is_answertarget_allowed(fctx, qname, aname, ardataset,
+		    type != ardataset->type &&
+		    type != dns_rdatatype_any &&
+		    !is_answertarget_allowed(fctx, qname, aname, ardataset,
 					      NULL))
 		{
 			return (DNS_R_SERVFAIL);
-- 
2.11.1

