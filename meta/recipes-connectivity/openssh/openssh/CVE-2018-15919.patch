From b4d069c2d41eca2db246bc42ed34239a4f778792 Mon Sep 17 00:00:00 2001
From: Anand Je Sypureddy <anandje@mvista.com>
Date: Mon, 17 Feb 2020 16:00:27 +0530
Subject: [PATCH] Fix for CVE-2018-15919

Upstream status: Backport [https://bugzilla.mindrot.org/attachment.cgi?id=3249]
CVE: CVE-2018-15919

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 auth2-gss.c | 6 ------
 auth2.c     | 3 +++
 2 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/auth2-gss.c b/auth2-gss.c
index eddd145..7b84495 100644
--- a/auth2-gss.c
+++ b/auth2-gss.c
@@ -98,12 +98,6 @@ userauth_gssapi(Authctxt *authctxt)
 		return (0);
 	}
 
-	if (!authctxt->valid || authctxt->user == NULL) {
-		debug2("%s: disabled because of invalid user", __func__);
-		free(doid);
-		return (0);
-	}
-
 	if (GSS_ERROR(PRIVSEP(ssh_gssapi_server_ctx(&ctxt, &goid)))) {
 		if (ctxt != NULL)
 			ssh_gssapi_delete_ctx(&ctxt);
diff --git a/auth2.c b/auth2.c
index 97dd2ef..305ac22 100644
--- a/auth2.c
+++ b/auth2.c
@@ -217,6 +217,7 @@ input_userauth_request(int type, u_int32_t seq, void *ctxt)
 	Authmethod *m = NULL;
 	char *user, *service, *method, *style = NULL;
 	int authenticated = 0;
+	int was_postponed = authctxt->postponed;
 
 	if (authctxt == NULL)
 		fatal("input_userauth_request: no authctxt");
@@ -283,6 +284,8 @@ input_userauth_request(int type, u_int32_t seq, void *ctxt)
 	if (m != NULL && authctxt->failures < options.max_authtries) {
 		debug2("input_userauth_request: try method %s", method);
 		authenticated =	m->userauth(authctxt);
+		if (!authenticated && was_postponed)
+			authctxt->failures++;
 	}
 	userauth_finish(authctxt, authenticated, method, NULL);
 
-- 
2.7.4

