From ed9de64c1ae6deee9006b9a235e8fa6e7ccdc4e5 Mon Sep 17 00:00:00 2001
From: drh <drh@noemail.net>
Date: Sat, 23 May 2020 19:58:07 +0000
Subject: [PATCH 1/8] Limit the "precision" of floating-point to text
 conversions in the printf() function to 100,000,000. Fix for ticket
 [23439ea582241138].

Upstream Status: Backport https://www.sqlite.org/src/vinfo/d08d3405878d394e?diff=1
CVE: CVE-2020-13434

FossilOrigin-Name: d08d3405878d394e08e5d3af281246edfbd81ca74cc8d16458808591512fb93d
Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 sqlite3.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/sqlite3.c b/sqlite3.c
index 1784c85..ebd13cb 100644
--- a/sqlite3.c
+++ b/sqlite3.c
@@ -28147,6 +28147,13 @@ static char *printfTempBuf(sqlite3_str *pAccum, sqlite3_int64 n){
 #endif
 #define etBUFSIZE SQLITE_PRINT_BUF_SIZE  /* Size of the output buffer */
 
+/*
+** Hard limit on the precision of floating-point conversions.
+*/
+#ifndef SQLITE_PRINTF_PRECISION_LIMIT
+# define SQLITE_FP_PRECISION_LIMIT 100000000
+#endif
+
 /*
 ** Render a string given by "fmt" into the StrAccum object.
 */
@@ -28468,6 +28475,11 @@ SQLITE_API void sqlite3_str_vappendf(
         length = 0;
 #else
         if( precision<0 ) precision = 6;         /* Set default precision */
+#ifdef SQLITE_FP_PRECISION_LIMIT
+        if( precision>SQLITE_FP_PRECISION_LIMIT ){
+          precision = SQLITE_FP_PRECISION_LIMIT;
+        }
+#endif
         if( realvalue<0.0 ){
           realvalue = -realvalue;
           prefix = '-';
-- 
2.27.0

