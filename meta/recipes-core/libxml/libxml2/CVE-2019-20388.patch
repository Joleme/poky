From 8a7c7b89dc93acb6f2ed5f9f29865d3643a50bfb Mon Sep 17 00:00:00 2001
From: Zhipeng Xie <xiezhipeng1@huawei.com>
Date: Tue, 20 Aug 2019 16:33:06 +0800
Subject: [PATCH] Fix memory leak in xmlSchemaValidateStream

When ctxt->schema is NULL, xmlSchemaSAXPlug->xmlSchemaPreRun
alloc a new schema for ctxt->schema and set vctxt->xsiAssemble
to 1. Then xmlSchemaVStart->xmlSchemaPreRun initialize
vctxt->xsiAssemble to 0 again which cause the alloced schema
can not be freed anymore.

Found with libFuzzer.

Upstream status: backport https://gitlab.gnome.org/haoren3696/libxml2/commit/6088a74bcf7d0c42e24cff4594d804e1d3c9fbca
CVE: CVE-2019-20388

Signed-off-by: Zhipeng Xie <xiezhipeng1@huawei.com>
Signed-off-by: Rahul Kumar <rahulk@mvista.com>
---
 xmlschemas.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/xmlschemas.c b/xmlschemas.c
index 405f72a..cf41d9b 100644
--- a/xmlschemas.c
+++ b/xmlschemas.c
@@ -28100,7 +28100,6 @@ xmlSchemaPreRun(xmlSchemaValidCtxtPtr vctxt) {
     vctxt->nberrors = 0;
     vctxt->depth = -1;
     vctxt->skipDepth = -1;
-    vctxt->xsiAssemble = 0;
     vctxt->hasKeyrefs = 0;
 #ifdef ENABLE_IDC_NODE_TABLES_TEST
     vctxt->createIDCNodeTables = 1;
-- 
2.7.4

