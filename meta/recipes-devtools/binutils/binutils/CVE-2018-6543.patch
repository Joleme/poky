From f2023ce7e8d70b0155cc6206c901e185260918f0 Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Thu, 1 Feb 2018 18:01:00 +1030
Subject: [PATCH] PR22769, crash when running 32-bit objdump on corrupted file

	PR 22769
	* objdump.c (load_specific_debug_section): Check for overflow
	when adding one to section size for a string section terminator.

Upstream-Status: Backport
CVE:  CVE-2018-6543
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 binutils/ChangeLog | 6 ++++++
 binutils/objdump.c | 7 +++++--
 2 files changed, 11 insertions(+), 2 deletions(-)

Index: git/binutils/objdump.c
===================================================================
--- git.orig/binutils/objdump.c
+++ git/binutils/objdump.c
@@ -2460,6 +2460,7 @@ load_specific_debug_section (enum dwarf_
   struct dwarf_section *section = &debug_displays [debug].section;
   bfd *abfd = (bfd *) file;
   bfd_boolean ret;
+  bfd_size_type amt;
 
   /* If it is already loaded, do nothing.  */
   if (section->start != NULL)
@@ -2469,11 +2470,13 @@ load_specific_debug_section (enum dwarf_
   section->num_relocs = 0;
   section->address = bfd_get_section_vma (abfd, sec);
   section->size = bfd_get_section_size (sec);
-  section->start = NULL;
+  amt = section->size + 1;
+  section->start = malloc (amt);
   section->user_data = sec;
-  ret = bfd_get_full_section_contents (abfd, sec, &section->start);
 
-  if (! ret)
+  if (amt == 0
+      || section->start == NULL
+      || !bfd_get_full_section_contents (abfd, sec, &section->start))
     {
       free_debug_section (debug);
       printf (_("\nCan't get contents for section '%s'.\n"),
@@ -2705,6 +2708,7 @@ read_section_stabs (bfd *abfd, const cha
 {
   asection *stabsect;
   bfd_byte *contents;
+  bfd_size_type amt;
 
   stabsect = bfd_get_section_by_name (abfd, sect_name);
   if (stabsect == NULL)
Index: git/binutils/ChangeLog
===================================================================
--- git.orig/binutils/ChangeLog
+++ git/binutils/ChangeLog
@@ -1,3 +1,9 @@
+2018-02-01  Alan Modra  <amodra@gmail.com>
+
+       PR 22769
+       * objdump.c (load_specific_debug_section): Check for overflow
+       when adding one to section size for a string section terminator.
+
 2018-04-17  Nick Clifton  <nickc@redhat.com>
 
        PR 23064
