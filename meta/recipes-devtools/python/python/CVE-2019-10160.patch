From 98a4dcefbbc3bce5ab07e7c0830a183157250259 Mon Sep 17 00:00:00 2001
From: Steve Dower <steve.dower@python.org>
Date: Wed, 1 May 2019 15:00:27 +0000
Subject: [PATCH] bpo-36742: Fixes handling of pre-normalization characters in
 urlsplit() (GH-13017)

Upstream-Status: Backport
CVE: CVE-2019-10160
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 Lib/test/test_urlparse.py                                     |  6 ++++++
 Lib/urlparse.py                                               | 11 +++++++----
 .../next/Security/2019-04-29-15-34-59.bpo-36742.QCUY0i.rst    |  1 +
 3 files changed, 14 insertions(+), 4 deletions(-)
 create mode 100644 Misc/NEWS.d/next/Security/2019-04-29-15-34-59.bpo-36742.QCUY0i.rst

Index: Python-2.7.16/Lib/test/test_urlparse.py
===================================================================
--- Python-2.7.16.orig/Lib/test/test_urlparse.py
+++ Python-2.7.16/Lib/test/test_urlparse.py
@@ -647,6 +647,12 @@ class UrlParseTestCase(unittest.TestCase
         with self.assertRaises(ValueError):
             urlparse.urlsplit(u'http://\u30d5\u309a\ufe1380')
 
+        # bpo-36742: Verify port separators are ignored when they
+        # existed prior to decomposition
+        urlparse.urlsplit(u'http://\u30d5\u309a:80')
+        with self.assertRaises(ValueError):
+            urlparse.urlsplit(u'http://\u30d5\u309a\ufe1380')
+
         for scheme in [u"http", u"https", u"ftp"]:
             for c in denorm_chars:
                 url = u"{}://netloc{}false.netloc/path".format(scheme, c)
