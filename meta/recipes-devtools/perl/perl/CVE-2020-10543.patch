From 16d4bd7d0b0d944409b15bc84b4004b15ba459de Mon Sep 17 00:00:00 2001
From: John Lightsey <jd@cpanel.net>
Date: Wed, 20 Nov 2019 20:02:45 -0600
Subject: [PATCH 1/3] regcomp.c: Prevent integer overflow from nested regex
 quantifiers.

(CVE-2020-10543) On 32bit systems the size calculations for nested regular
expression quantifiers could overflow causing heap memory corruption.

Upstream Status: Backport https://github.com/perl/perl5/commit/897d1f7f
CVE: CVE-2020-10543

Fixes: Perl/perl5-security#125
(cherry picked from commit bfd31397db5dc1a5c5d3e0a1f753a4f89a736e71)
Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 regcomp.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/regcomp.c b/regcomp.c
index 3fb7d8b..7f950d1 100644
--- a/regcomp.c
+++ b/regcomp.c
@@ -5065,6 +5065,12 @@ S_study_chunk(pTHX_ RExC_state_t *pRExC_state, regnode **scanp,
 		    (void)ReREFCNT_inc(RExC_rx_sv);
 		}
 
+                if ( ( minnext > 0 && mincount >= SSize_t_MAX / minnext )
+                    || min >= SSize_t_MAX - minnext * mincount )
+                {
+                    FAIL("Regexp out of space");
+                }
+
 		min += minnext * mincount;
 		is_inf_internal |= deltanext == SSize_t_MAX
                          || (maxcount == REG_INFTY && minnext + deltanext > 0);
-- 
2.28.0

