From fa143661accc9a6d363b583ae05a8715435b303e Mon Sep 17 00:00:00 2001
From: Karl Williamson <khw@cpan.org>
Date: Mon, 24 Sep 2018 11:16:14 -0600
Subject: [PATCH 1/3] PATCH: [perl #133423]

CVE: CVE-2018-18312
Upstream-Status: Backport
Signed-off-by: Sam Kappen <skappen@mvista.com>
---
 regcomp.c       | 1 -
 t/re/reg_mesg.t | 3 +++
 2 files changed, 3 insertions(+), 1 deletion(-)
 mode change 100644 => 100755 t/re/reg_mesg.t

diff --git a/regcomp.c b/regcomp.c
index 903cdaa..0d2319c 100644
--- a/regcomp.c
+++ b/regcomp.c
@@ -14874,7 +14874,6 @@ redo_curchar:
                     RExC_parse++;
                     assert(UCHARAT(RExC_parse) == ')');
 
-                    RExC_parse++;
                     RExC_flags = save_flags;
                     goto handle_operand;
                 }
diff --git a/t/re/reg_mesg.t b/t/re/reg_mesg.t
old mode 100644
new mode 100755
index 0fe4539..2e9cc8a
--- a/t/re/reg_mesg.t
+++ b/t/re/reg_mesg.t
@@ -96,6 +96,8 @@ my $tab_hex = sprintf "%02X", ord("\t");
 ##
 ## Key-value pairs of code/error of code that should have fatal errors.
 ##
+my $bug133423 = "(?[(?^:(?[\\\x00]))\\]\x00|2[^^]\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80])R.\\670";
+
 my @death =
 (
  '/[[=foo=]]/' => 'POSIX syntax [= =] is reserved for future extensions {#} m/[[=foo=]{#}]/',
@@ -268,6 +270,7 @@ my @death =
  '/(?[\ |!])/' => 'Incomplete expression within \'(?[ ])\' {#} m/(?[\ |!{#}])/',    # [perl #126180]
  '/(?[()-!])/' => 'Incomplete expression within \'(?[ ])\' {#} m/(?[()-!{#}])/',    # [perl #126204]
  '/(?[!()])/' => 'Incomplete expression within \'(?[ ])\' {#} m/(?[!(){#}])/',      # [perl #126404]
+ "/$bug133423/" => "Operand with no preceding operator {#} m/(?[(?^:(?[\\^@]))\\{#}]^@|2[^^]\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80\x80])R.\\670/",
 );
 
 # These are messages that are warnings when not strict; death under 'use re
-- 
2.7.4

