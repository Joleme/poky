From 23d06da887d230fef1726af1dca48ec7ee3bd529 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Wed, 16 Jan 2019 11:57:35 +0100
Subject: [PATCH 3/6] libebl: Check GNU property note pr_datasz fits inside
 note description.

Before printing the data values, make sure pr_datasz doesn't go beyond
the end of the note description data.

https://sourceware.org/bugzilla/show_bug.cgi?id=24075

CVE-2019-7146
Upstream-Status: Backport

Signed-off-by: Mark Wielaard <mark@klomp.org>
Signed-off-by: Sam Kappen <skappen@mvista.com>
---
 libebl/ChangeLog    | 4 ++++
 libebl/eblobjnote.c | 7 +++++++
 2 files changed, 11 insertions(+)

diff --git a/libebl/ChangeLog b/libebl/ChangeLog
index a2f8956..9045955 100644
--- a/libebl/ChangeLog
+++ b/libebl/ChangeLog
@@ -1,3 +1,7 @@
+2019-01-16  Mark Wielaard  <mark@klomp.org>
+
+       * eblobjnte.c (ebl_object_note): Check pr_datasz isn't too large.
+
 2018-11-15  Mark Wielaard  <mark@klomp.org>
 
 	* eblobjnotetypename.c (ebl_object_note_type_name): Don't update
diff --git a/libebl/eblobjnote.c b/libebl/eblobjnote.c
index 58ac86d..cf75f3e 100644
--- a/libebl/eblobjnote.c
+++ b/libebl/eblobjnote.c
@@ -350,6 +350,13 @@ ebl_object_note (Ebl *ebl, uint32_t namesz, const char *name, uint32_t type,
 		  desc += 8;
 		  descsz -= 8;
 
+		  if (prop.pr_datasz > descsz)
+		    {
+		      printf ("BAD property datasz: %" PRId32 "\n",
+			      prop.pr_datasz);
+		      return;
+		    }
+
 		  int elfclass = gelf_getclass (ebl->elf);
 		  char *elfident = elf_getident (ebl->elf, NULL);
 		  GElf_Ehdr ehdr;
-- 
2.7.4

